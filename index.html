<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas</title>
    <style>
        canvas {
            background-color: lightgray;
            border: 4px solid gray;
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
    </style>
</head>

<body onload="startGame()">
    <script>
        const PLAYER_WIDTH = 300 / 15
        const PLAYER_HEIGHT = 300 / 15
        var fruitInterval = 2000

        var player
        var points = 0;

        var gameOver
        var difficulty
        var fruitI

        function startGame() {
            gameArea.start()
            player = new component(PLAYER_WIDTH, PLAYER_HEIGHT, "red", PLAYER_WIDTH, PLAYER_HEIGHT)
            fruitInterval = 2000
            gameOver = false
            player.body.push(new bodyPiece(player.body[player.body.length - 1].a - PLAYER_WIDTH, player.body[player.body.length - 1].b))
        }

        var gameArea = {
            canvas: document.createElement('canvas'),
            start: function () {
                this.canvas.height = 540
                this.canvas.weight = 200
                this.context = this.canvas.getContext('2d')
                document.body.insertBefore(this.canvas, document.body.childNodes[0])
                this.interval = setInterval(updateGameArea, 20)
                difficulty = setInterval(increaseDifficulty, 10000)
                clearInterval(fruitI)
                fruitI = setInterval(generateFruit, fruitInterval)
            },
            clear: function () {
                ctx = this.canvas.getContext('2d')
                ctx.clearRect(0, 0, this.canvas.width, this.canvas.height)
                ctx.font = 100 + " " + 50;
                ctx.fillStyle = "gray";
                ctx.fillText("Score: " + points.toString(), this.canvas.width - 50, 15);
            },
            stop: function () {
                clearInterval(this.interval)
            }
        }


        function component(width, height, color, a, b) {
            this.width = width
            this.height = height
            this.body = [new bodyPiece(a, b)]
            this.firstPiece = this.body[0]
            this.direction = "ArrowRight"
            this.update = function () {
                ctx = gameArea.context
                ctx.fillStyle = color
                let i
                for (i = 0; i < this.body.length; i++) {
                    ctx.fillRect(this.body[i].a, this.body[i].b, this.width, this.height)
                }
            }
        }

        function updateGameArea() {
            if (!gameOver) {
                gameArea.clear()
                player.update()
                updateFruits()
                verifyPoint()
                verifyGameOver()
            }
        }

        var bodyPiece = function (a, b) {
            this.a = a
            this.b = b
        }

        const movPlayer = {
            ArrowRight: function () {
                console.log("Player is moving RIGHT")
                let firstPieceA = player.firstPiece.a
                let firstPieceB = player.firstPiece.b
                if (player.firstPiece.a + PLAYER_WIDTH < gameArea.canvas.width)
                    player.firstPiece.a += PLAYER_WIDTH
                else
                    player.firstPiece.a = 0
                if (player.body.length > 1) {
                    var oldPositionA
                    var oldPositionB
                    for (let i = 1; i < player.body.length; i++) {
                        if (i == 1) {
                            oldPositionA = player.body[i].a
                            oldPositionB = player.body[i].b
                            console.log(player.body[i].a)
                            player.body[i].a = firstPieceA
                            console.log(player.body[i].a)
                            player.body[i].b = firstPieceB
                        }
                        else {
                            let aux = player.body[i].a
                            player.body[i].a = oldPositionA
                            oldPositionA = aux
                            aux = player.body[i].b
                            player.body[i].b = oldPositionB
                            oldPositionB = aux
                        }
                    }
                }
            },

            ArrowLeft: function () {
                console.log("Player is moving LEFT")
                if (player.firstPiece.a - PLAYER_WIDTH >= 0)
                    player.firstPiece.a -= PLAYER_WIDTH
                else
                    player.firstPiece.a = gameArea.canvas.width - PLAYER_WIDTH
            },

            ArrowUp: function () {
                console.log("Player is moving UP")
                if (player.firstPiece.b - PLAYER_HEIGHT >= 0)
                    player.firstPiece.b -= PLAYER_HEIGHT
                else
                    player.firstPiece.b = gameArea.canvas.height - PLAYER_HEIGHT
            },

            ArrowDown: function () {
                console.log("Player is moving DOWN")
                if (player.firstPiece.b + PLAYER_HEIGHT < gameArea.canvas.height)
                    player.firstPiece.b += PLAYER_HEIGHT
                else
                    player.firstPiece.b = 0
            }

        }

        document.addEventListener('keydown', function (event) {
            if (movPlayer[event.key]())
                movPlayer[event.key]()
        })

        var fruit = function (a, b) {
            this.x = a
            this.y = b
        }

        var fruits = []

        function generateFruit() {
            if (!gameOver) {
                do {
                    freeSlot = true
                    do {
                        a = Math.random() * (gameArea.canvas.width)
                        a = parseInt(a)
                    } while (a % PLAYER_WIDTH != 0)
                    do {
                        b = Math.random() * (gameArea.canvas.height)
                        b = parseInt(b)
                    } while (b % PLAYER_HEIGHT != 0)
                    if (a == player.firstPiece.a && b == player.firstPiece.b)
                        freeSlot = false
                    else for (i = 0; i < fruits.length; i++) {
                        if (a == fruits[i].x && b == fruits[i].y)
                            freeSlot = false
                    }
                } while (!freeSlot)

                fruits.push(new fruit(a, b))
            }
        }

        function updateFruits() {
            for (i = 0; i < fruits.length; i++) {
                gameArea.context.fillStyle = "green"
                gameArea.context.fillRect(fruits[i].x, fruits[i].y, PLAYER_WIDTH, PLAYER_HEIGHT)
            }
        }

        function verifyGameOver() {
            if (fruits.length > 10) {
                ctx = gameArea.context
                ctx.fillStyle = 'rgba(128, 128, 128, 0.707)'
                ctx.fillRect(0, 0, 300, 540)
                ctx.font = 300 + " " + 75;
                ctx.fillStyle = "white";
                ctx.textAlign = "center"
                ctx.fillText("Score: " + points, gameArea.canvas.width / 2, gameArea.canvas.height / 2 - 25);
                ctx.fillText("Press ENTER to continue", gameArea.canvas.width / 2, gameArea.canvas.height / 2 + 25);
                fruits.splice(0, fruits.length - 1)
                points = 0
                gameOver = true
                clearInterval(difficulty)
                clearInterval(fruitI)
                gameArea.stop()
            }
        }

        document.addEventListener("keydown", function (event) {
            if (gameOver && event.key == "Enter")
                startGame()
        })

        function verifyPoint() {
            for (i = 0; i < fruits.length; i++) {
                if (player.firstPiece.a == fruits[i].x && player.firstPiece.b == fruits[i].y) {
                    fruits.splice(i, 1)
                    points++;
                }
            }
        }

        function increaseDifficulty() {
            if (fruitInterval > 1000) {
                fruitInterval -= 100
                clearInterval(fruitI)
                fruitI = setInterval(generateFruit, fruitInterval)
                console.log(fruitInterval)
            }
        }

        // Funções experimentais para o jogo Snake-----------------------------------------

        document.addEventListener("keydown", function (event) {
            if (event.key.startsWith("Arrow"))
                player.direction = event.key
        })

        function autoMovePlayer() {
            if (playerMovs[player.direction]) {
                playerMovs[player.direction]()
            }
        }

        const playerMovs = {
            ArrowRight: function () {
                movPlayer.ArrowRight()
            },

            ArrowLeft: function () {
                movPlayer.ArrowLeft()
            },

            ArrowUp: function () {
                movPlayer.ArrowUp()
            },

            ArrowDown: function () {
                movPlayer.ArrowDown()
            },
        }



        setInterval(autoMovePlayer, 1000)

    </script>
</body>

</html>